<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1267px" preserveAspectRatio="none" style="width:1067px;height:1267px;background:#FFFFFF;" version="1.1" viewBox="0 0 1067 1267" width="1067px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="551.4004" style="stroke:#000000;stroke-width:1.5;" width="1047" x="10" y="286.6"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="53" x2="53" y1="36.7999" y2="1231.8006"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="408.5" x2="408.5" y1="36.7999" y2="1231.8006"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="574" x2="574" y1="36.7999" y2="1231.8006"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="807.5" x2="807.5" y1="36.7999" y2="1231.8006"/><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="67" x="20" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53" x="27" y="25.0059">S3Client</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="67" x="20" y="1230.8006"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53" x="27" y="1250.8066">S3Client</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="373.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="380.5" y="25.0059">Gateway</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="373.5" y="1230.8006"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="380.5" y="1250.8066">Gateway</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="548" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="555" y="25.0059">Uplink</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="548" y="1230.8006"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="555" y="1250.8066">Uplink</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="64" x="775.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="782.5" y="25.0059">Satellite</text><rect fill="#E2E2F0" height="30.7999" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="64" x="775.5" y="1230.8006"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="782.5" y="1250.8066">Satellite</text><polygon fill="#181818" points="396.5,64.3999,406.5,68.3999,396.5,72.3999,400.5,68.3999" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="53.5" x2="402.5" y1="68.3999" y2="68.3999"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="60.5" y="62.8769">PUT /bucket/dest?uploads</text><polygon fill="#181818" points="562.5,112.6,572.5,116.6,562.5,120.6,566.5,116.6" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="408.5" x2="568.5" y1="116.6" y2="116.6"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="415.5" y="111.077">BeginUpload (multipart)</text><path d="M338,81.3999 L338,137.3999 L403,137.3999 L403,91.3999 L393,81.3999 L338,81.3999 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M393,81.3999 L393,91.3999 L403,91.3999 L393,81.3999 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="344" y="98.477">Bucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="344" y="114.077">Key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="344" y="129.677">Expires</text><polygon fill="#181818" points="795.5,160.8,805.5,164.8,795.5,168.8,799.5,164.8" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="574.5" x2="801.5" y1="164.8" y2="164.8"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="581.5" y="159.277">BeginObjectRequest</text><polygon fill="#181818" points="585.5,193.4,575.5,197.4,585.5,201.4,581.5,197.4" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="579.5" x2="806.5" y1="197.4" y2="197.4"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="591.5" y="191.877">BeginObjectResponse</text><path d="M812,177.8 L812,202.8 L888,202.8 L888,187.8 L878,177.8 L812,177.8 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M878,177.8 L878,187.8 L888,187.8 L878,177.8 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="818" y="194.877">StreamID</text><polygon fill="#181818" points="419.5,229,409.5,233,419.5,237,415.5,233" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="413.5" x2="573.5" y1="233" y2="233"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="425.5" y="227.477">BeginUpload return</text><path d="M579,213.4 L579,238.4 L655,238.4 L655,223.4 L645,213.4 L579,213.4 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M645,213.4 L645,223.4 L655,223.4 L645,213.4 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="585" y="230.477">StreamID</text><polygon fill="#181818" points="64.5,264.6,54.5,268.6,64.5,272.6,60.5,268.6" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="58.5" x2="407.5" y1="268.6" y2="268.6"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="70.5" y="263.077">200 response</text><path d="M413,249 L413,274 L509,274 L509,259 L499,249 L413,249 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M499,249 L499,259 L509,259 L499,249 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="419" y="266.077">&lt;UploadId /&gt;</text><path d="M10,286.6 L169,286.6 L169,294.2001 L159,304.2001 L10,304.2001 L10,286.6 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="551.4004" style="stroke:#000000;stroke-width:1.5;" width="1047" x="10" y="286.6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="114" x="25" y="299.677">loop for every part</text><polygon fill="#181818" points="396.5,353.0001,406.5,357.0001,396.5,361.0001,400.5,357.0001" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="53.5" x2="402.5" y1="357.0001" y2="357.0001"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="60.5" y="320.2771">PUT /bucket/dest?partNumber=1&amp;uploadId=7tKsLOJgNs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="60.5" y="335.8771">x-amz-copy-source: /bucket/source</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="60.5" y="351.4771">x-amz-copy-source-range:bytes=0-5368709120</text><polygon fill="#181818" points="562.5,440.2002,572.5,444.2002,562.5,448.2002,566.5,444.2002" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="408.5" x2="568.5" y1="444.2002" y2="444.2002"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="415.5" y="438.6772">CopyObjectRange</text><path d="M276,370.0001 L276,504.0001 L403,504.0001 L403,380.0001 L393,370.0001 L276,370.0001 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M393,370.0001 L393,380.0001 L403,380.0001 L393,370.0001 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="282" y="387.0771">UploadID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="282" y="402.6771">DestinationBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="282" y="418.2771">DestinationKey</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="282" y="433.8771">DestinationPart</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="282" y="449.4772">SourceBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="282" y="465.0772">SourceKey</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="282" y="480.6772">StartOffset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="282" y="496.2772">EndOffset</text><polygon fill="#181818" points="795.5,554.7752,805.5,558.7752,795.5,562.7752,799.5,558.7752" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="574.5" x2="801.5" y1="558.7752" y2="558.7752"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="581.5" y="553.2522">BeginCopyObjectRangeRequest</text><path d="M423,514.8002 L423,588.8002 L569,588.8002 L569,524.8002 L559,514.8002 L423,514.8002 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M559,514.8002 L559,524.8002 L569,524.8002 L559,514.8002 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="429" y="531.8772">SourceBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="429" y="549.4272">SourceKey</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="57" x="497" y="549.7002">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="429" y="565.0272">SourceOffset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="429" y="580.6273">Size</text><polygon fill="#181818" points="585.5,615.7253,575.5,619.7253,585.5,623.7253,581.5,619.7253" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="579.5" x2="806.5" y1="619.7253" y2="619.7253"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="591.5" y="614.2023">BeginCopyObjectRangeResponse</text><path d="M812,599.1503 L812,626.1503 L976,626.1503 L976,609.1503 L966,599.1503 L812,599.1503 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M966,599.1503 L966,609.1503 L976,609.1503 L966,599.1503 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="818" y="618.1773">SegmentKeys</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="57" x="904" y="618.4503">encrypted</text><polygon fill="#181818" points="795.5,737.2004,805.5,741.2004,795.5,745.2004,799.5,741.2004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="574.5" x2="801.5" y1="741.2004" y2="741.2004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="581.5" y="735.6774">FinishCopyObjectRangeRequest</text><path d="M399,636.7003 L399,743.7003 L569,743.7003 L569,646.7003 L559,636.7003 L399,636.7003 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M559,636.7003 L559,646.7003 L569,646.7003 L559,636.7003 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="405" y="653.7773">DestinationStreamID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="405" y="669.3773">DestinationBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="405" y="686.9273">DestinationKey</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="57" x="497" y="687.2003">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="405" y="702.5273">DestinationPart</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="405" y="718.1273">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="405" y="735.6774">SegmentKeys</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="57" x="491" y="735.9504">encrypted</text><path d="M812,662.0503 L812,718.0503 L1042,718.0503 L1042,672.0503 L1032,662.0503 L812,662.0503 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><path d="M1032,662.0503 L1032,672.0503 L1042,672.0503 L1032,662.0503 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="818" y="679.1273">Create entries in segment table</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="818" y="694.7273"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="818" y="710.3273">Create 1 entry in pending_copy_part</text><polygon fill="#181818" points="585.5,766.8004,575.5,770.8004,585.5,774.8004,581.5,770.8004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="579.5" x2="806.5" y1="770.8004" y2="770.8004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="591.5" y="765.2774">FinishCopyObjectRangeResponmse</text><polygon fill="#181818" points="419.5,796.4004,409.5,800.4004,419.5,804.4004,415.5,800.4004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="413.5" x2="573.5" y1="800.4004" y2="800.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="425.5" y="794.8774">CopyObjectRange return</text><polygon fill="#181818" points="64.5,826.0004,54.5,830.0004,64.5,834.0004,60.5,830.0004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="58.5" x2="407.5" y1="830.0004" y2="830.0004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="70.5" y="824.4774">200 response</text><polygon fill="#181818" points="396.5,862.6004,406.5,866.6004,396.5,870.6004,400.5,866.6004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="53.5" x2="402.5" y1="866.6004" y2="866.6004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250" x="60.5" y="861.0774">POST /bucket/dest?uploadId=7tKsLOJgNs</text><polygon fill="#181818" points="562.5,918.6004,572.5,922.6004,562.5,926.6004,566.5,922.6004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="408.5" x2="568.5" y1="922.6004" y2="922.6004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="415.5" y="917.0774">CommitUpload</text><path d="M283,879.6004 L283,951.6004 L403,951.6004 L403,889.6004 L393,879.6004 L283,879.6004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M393,879.6004 L393,889.6004 L403,889.6004 L393,879.6004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="289" y="896.6774">Bucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="289" y="912.2774">Key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="289" y="927.8774">UploadID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="289" y="943.4775">CustomMetadata</text><polygon fill="#181818" points="795.5,1121.0006,805.5,1125.0006,795.5,1129.0006,799.5,1125.0006" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="574.5" x2="801.5" y1="1125.0006" y2="1125.0006"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="581.5" y="1119.4776">ObjectCommitRequest</text><path d="M392,1023.4255 L392,1066.4255 L569,1066.4255 L569,1033.4255 L559,1023.4255 L392,1023.4255 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M559,1023.4255 L559,1033.4255 L569,1033.4255 L559,1023.4255 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="398" y="1040.5025">StreamID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="398" y="1058.0525">CustomMetadata</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="53" x="501" y="1058.3255">encypted</text><path d="M812,962.0005 L812,1128.0005 L1060,1128.0005 L1060,972.0005 L1050,962.0005 L812,962.0005 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><path d="M1050,962.0005 L1050,972.0005 L1060,972.0005 L1050,962.0005 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="818" y="979.0775">Verify source object key and stream_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="818" y="994.6775">is the same for every part.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="818" y="1010.2775"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="818" y="1025.8775">Check that source object still exists</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="818" y="1041.4775"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="818" y="1057.0775">Verify part offsets and sizes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="818" y="1072.6776">add up to entire object.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="818" y="1088.2776"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="818" y="1103.8776">Change destination object status from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="818" y="1119.4776">pending to committed.</text><polygon fill="#181818" points="585.5,1150.6006,575.5,1154.6006,585.5,1158.6006,581.5,1154.6006" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="579.5" x2="806.5" y1="1154.6006" y2="1154.6006"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="591.5" y="1149.0776">ObjectCommitResponse</text><polygon fill="#181818" points="419.5,1180.2006,409.5,1184.2006,419.5,1188.2006,415.5,1184.2006" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="413.5" x2="573.5" y1="1184.2006" y2="1184.2006"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="425.5" y="1178.6776">CommitUpload return</text><polygon fill="#181818" points="64.5,1209.8006,54.5,1213.8006,64.5,1217.8006,60.5,1213.8006" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="58.5" x2="407.5" y1="1213.8006" y2="1213.8006"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="70.5" y="1208.2776">200 response</text><!--MD5=[5861ae878aa1389d1502d28c43480dad]
@startuml

S3Client -> Gateway: PUT /bucket/dest?uploads

Gateway -> Uplink: BeginUpload (multipart)
note left
    Bucket
    Key
    Expires
end note

Uplink -> Satellite: BeginObjectRequest

Uplink <- - Satellite: BeginObjectResponse
note right
    StreamID
end note

Gateway <- - Uplink: BeginUpload return
note right
    StreamID
end note

S3Client <- - Gateway: 200 response
note right
    <UploadId />
end note

group loop for every part
    S3Client -> Gateway: PUT /bucket/dest?partNumber=1&uploadId=7tKsLOJgNs\nx-amz-copy-source: /bucket/source\nx-amz-copy-source-range:bytes=0-5368709120

    Gateway -> Uplink: CopyObjectRange
    note left
        UploadID
        DestinationBucket
        DestinationKey
        DestinationPart
        SourceBucket
        SourceKey
        StartOffset
        EndOffset
    end note

    Uplink -> Satellite: BeginCopyObjectRangeRequest
    note left
        SourceBucket
        SourceKey //encrypted//
        SourceOffset
        Size
    end note

    Uplink <- - Satellite: BeginCopyObjectRangeResponse
    note right
        SegmentKeys //encrypted//
    end note

    Uplink -> Satellite: FinishCopyObjectRangeRequest
    note left
        DestinationStreamID
        DestinationBucket
        DestinationKey //encrypted//
        DestinationPart
        ...
        SegmentKeys //encrypted//
    end note
    note right #lightgreen
        Create entries in segment table

        Create 1 entry in pending_copy_part
    end note

    Uplink <- - Satellite: FinishCopyObjectRangeResponmse

    Gateway <- - Uplink: CopyObjectRange return

    S3Client <- - Gateway: 200 response
end

S3Client -> Gateway: POST /bucket/dest?uploadId=7tKsLOJgNs

Gateway -> Uplink: CommitUpload
note left
    Bucket
    Key
    UploadID
    CustomMetadata
end note

Uplink -> Satellite: ObjectCommitRequest
note left
    StreamID
    CustomMetadata //encypted//
end note
note right #lightgreen
    Verify source object key and stream_id
    is the same for every part.

    Check that source object still exists

    Verify part offsets and sizes
    add up to entire object.

    Change destination object status from
    pending to committed.
end note

Uplink <- - Satellite: ObjectCommitResponse

Gateway <- - Uplink: CommitUpload return

S3Client <- - Gateway: 200 response

@enduml

PlantUML version 1.2022.7(Mon Aug 22 19:01:30 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>